name: Build Multi-Architecture Docker Image

on:
  push:
    branches: [ main, develop ]
    tags: [ 'v*' ]
    paths:
      - 'package.json'  
  pull_request:
    branches: [ main ]
    paths:
      - 'package.json'

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Record build start time
      id: start-time
      run: echo "start_time=$(date +%s)" >> $GITHUB_OUTPUT
    
    # ğŸ“¦ ä»package.jsonè¯»å–nameå’Œversion
    - name: Extract package.json metadata
      id: package-info
      run: |
        if [ -f "package.json" ]; then
          NAME=$(node -p "require('./package.json').name")
          VERSION=$(node -p "require('./package.json').version")
          
          # æ¸…ç†nameï¼šç§»é™¤scopeå‰ç¼€ (@scope/name â†’ name)
          CLEAN_NAME=$(echo "$NAME" | sed 's|^@[^/]*/||')
          
          echo "name=${NAME}" >> $GITHUB_OUTPUT
          echo "clean_name=${CLEAN_NAME}" >> $GITHUB_OUTPUT
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "has_package_json=true" >> $GITHUB_OUTPUT
          
          echo "ğŸ“¦ Package name: ${NAME}"
          echo "ğŸ“¦ Clean name: ${CLEAN_NAME}"
          echo "ğŸ“¦ Version: ${VERSION}"
        else
          # å¦‚æœæ²¡æœ‰package.jsonï¼Œå›é€€åˆ°ä»“åº“å
          REPO_NAME=$(echo "${{ github.event.repository.name }}" | tr '[:upper:]' '[:lower:]')
          echo "clean_name=${REPO_NAME}" >> $GITHUB_OUTPUT
          echo "has_package_json=false" >> $GITHUB_OUTPUT
          echo "âš ï¸ No package.json found, using repository name: ${REPO_NAME}"
        fi
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      with:
        platforms: linux/amd64,linux/arm64
    
    - name: Set up QEMU
      uses: docker/setup-qemu-action@v3
      with:
        platforms: arm64
    
    - name: Login to Docker Hub
      if: github.event_name != 'pull_request'
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}
    
    # ğŸ·ï¸ ä½¿ç”¨package.jsonçš„nameæ„å»ºé•œåƒå
    - name: Generate Docker tags
      id: tags
      run: |
        # ä½¿ç”¨package.jsonçš„nameï¼ˆæ¸…ç†åï¼‰ä½œä¸ºé•œåƒå
        DOCKERHUB_REPO="${{ secrets.DOCKERHUB_USERNAME }}/${{ steps.package-info.outputs.clean_name }}"
        
        if [ "${{ github.event_name }}" = "pull_request" ]; then
          # PR: åªç”ŸæˆPRæ ‡ç­¾ç”¨äºæµ‹è¯•
          TAGS="${DOCKERHUB_REPO}:pr-${{ github.event.number }}"
        else
          # æ€»æ˜¯åŒ…å«latestæ ‡ç­¾
          TAGS="${DOCKERHUB_REPO}:latest"
          
          # å¦‚æœæœ‰package.jsonï¼Œæ·»åŠ vå‰ç¼€ç‰ˆæœ¬æ ‡ç­¾
          if [ "${{ steps.package-info.outputs.has_package_json }}" = "true" ]; then
            PACKAGE_VERSION="${{ steps.package-info.outputs.version }}"
            TAGS="${TAGS},${DOCKERHUB_REPO}:v${PACKAGE_VERSION}"
            echo "ğŸ“¦ Adding version tag: v${PACKAGE_VERSION}"
          fi
        fi
        
        echo "repository=${DOCKERHUB_REPO}" >> $GITHUB_OUTPUT
        echo "tags=${TAGS}" >> $GITHUB_OUTPUT
        echo "ğŸ·ï¸ Docker repository: ${DOCKERHUB_REPO}"
        echo "ğŸ·ï¸ Generated tags: ${TAGS}"
    
    # ğŸ—ï¸ æ„å»ºå’Œæ¨é€
    - name: Build and push multi-architecture image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./docker/Dockerfile
        platforms: linux/amd64,linux/arm64
        push: ${{ github.event_name != 'pull_request' }}
        tags: ${{ steps.tags.outputs.tags }}
        # æ·»åŠ æ„å»ºæ ‡ç­¾
        labels: |
          org.opencontainers.image.title=${{ steps.package-info.outputs.name || github.event.repository.name }}
          org.opencontainers.image.description=Auto-built from ${{ github.ref_name }}
          org.opencontainers.image.version=${{ steps.package-info.outputs.version || 'unknown' }}
          org.opencontainers.image.source=${{ github.event.repository.html_url }}
          org.opencontainers.image.revision=${{ github.sha }}
          org.opencontainers.image.created=${{ github.event.head_commit.timestamp }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        outputs: type=image,name=target
    
    # ğŸ“Š æ„å»ºæ‘˜è¦
    - name: Calculate build duration and summary
      id: build-summary
      run: |
        start_time=${{ steps.start-time.outputs.start_time }}
        end_time=$(date +%s)
        duration=$((end_time - start_time))
        minutes=$((duration / 60))
        seconds=$((duration % 60))
        
        echo "Build completed in ${minutes}m ${seconds}s"
        echo "build_duration=${duration}" >> $GITHUB_OUTPUT
        echo "formatted_duration=${minutes}m ${seconds}s" >> $GITHUB_OUTPUT
        
        echo "## ğŸš€ Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "| Item | Value |" >> $GITHUB_STEP_SUMMARY
        echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
        echo "| **Event Type** | \`${{ github.event_name }}\` |" >> $GITHUB_STEP_SUMMARY
        echo "| **Branch/Tag** | \`${{ github.ref_name }}\` |" >> $GITHUB_STEP_SUMMARY
        echo "| **Commit SHA** | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
        echo "| **Build Duration** | **${minutes}m ${seconds}s** |" >> $GITHUB_STEP_SUMMARY
        echo "| **Architectures** | \`linux/amd64\`, \`linux/arm64\` |" >> $GITHUB_STEP_SUMMARY
        echo "| **Docker Repository** | \`${{ steps.tags.outputs.repository }}\` |" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ steps.package-info.outputs.has_package_json }}" = "true" ]; then
          echo "| **Package Name** | \`${{ steps.package-info.outputs.name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Package Version** | \`${{ steps.package-info.outputs.version }}\` |" >> $GITHUB_STEP_SUMMARY
        else
          echo "| **Source** | Repository name (no package.json) |" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ "${{ github.event_name }}" != "pull_request" ]; then
          echo "| **Action** | âœ… **Built and Pushed** |" >> $GITHUB_STEP_SUMMARY
          echo "| **Registry** | Docker Hub |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“¦ Generated Tags:" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.tags.outputs.tags }}" | tr ',' '\n' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ¯ Usage Examples:" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "# Pull latest version (recommended)" >> $GITHUB_STEP_SUMMARY
          echo "docker pull ${{ steps.tags.outputs.repository }}:latest" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.package-info.outputs.has_package_json }}" = "true" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "# Pull specific version" >> $GITHUB_STEP_SUMMARY
            echo "docker pull ${{ steps.tags.outputs.repository }}:v${{ steps.package-info.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Run container" >> $GITHUB_STEP_SUMMARY
          echo "docker run -p 3000:3000 ${{ steps.tags.outputs.repository }}:latest" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
        else
          echo "| **Action** | ğŸ” **Built Only (PR)** |" >> $GITHUB_STEP_SUMMARY
        fi
    
    - name: Build performance check
      if: steps.build-summary.outputs.build_duration > 600
      run: |
        echo "âš ï¸ Warning: Build took longer than 10 minutes (${{ steps.build-summary.outputs.formatted_duration }})"
        echo "Consider optimizing:"
        echo "- Review Dockerfile for unnecessary operations"
        echo "- Check if cache is working properly" 
        echo "- Consider using multi-stage builds"

    - name: Build success notification
      run: |
        echo "âœ… Multi-architecture Docker image build completed successfully!"
        echo "ğŸ“Š Build Duration: ${{ steps.build-summary.outputs.formatted_duration }}"
        echo "ğŸ—ï¸ Architectures: linux/amd64, linux/arm64"
        echo "ğŸ³ Docker Repository: ${{ steps.tags.outputs.repository }}"
        
        if [ "${{ github.event_name }}" != "pull_request" ]; then
          echo "ğŸ“¤ Pushed to Docker Hub: ${{ steps.tags.outputs.repository }}"
          echo "ğŸ·ï¸ Tags pushed:"
          echo "  - latest (always updated)"
          if [ "${{ steps.package-info.outputs.has_package_json }}" = "true" ]; then
            echo "  - v${{ steps.package-info.outputs.version }} (from package.json)"
            echo "ğŸ“¦ Package: ${{ steps.package-info.outputs.name }}"
          fi
        else
          echo "ğŸ” PR Build: Images built but not pushed"
        fi
